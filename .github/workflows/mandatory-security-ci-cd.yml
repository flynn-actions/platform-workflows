name: Mandatory Security Platform Pipeline

on:
  workflow_call:
    inputs:
      environment:
        description: 'Deployment environment'
        required: false
        default: 'staging'
        type: string
      node_version:
        description: 'Node.js version to use'
        required: false
        type: string
        default: '18'
      # Security cannot be disabled - removed the option
      skip_tests:
        description: 'Skip tests (security always runs)'
        required: false
        type: boolean
        default: false

jobs:
  # Stage 1: Setup and Validation
  setup:
    name: "ğŸ”§ Environment Setup"
    runs-on: ubuntu-latest
    outputs:
      build-id: ${{ steps.generate-id.outputs.build-id }}
      environment: ${{ inputs.environment }}
    steps:
      - name: Pipeline Information
        run: |
          echo "ğŸš€ MANDATORY Security Platform Pipeline"
          echo "Repository: ${{ github.repository }}"
          echo "Environment: ${{ inputs.environment }}"
          echo "ğŸ”’ Security scanning: MANDATORY (cannot be disabled)"
          
      - name: Generate Build ID
        id: generate-id
        run: |
          BUILD_ID="build-$$(date +%Y%m%d)-$$(echo ${{ github.sha }} | cut -c1-8)"
          echo "build-id=$$BUILD_ID" >> $$GITHUB_OUTPUT
          echo "Generated Build ID: $$BUILD_ID"

  # Stage 2: MANDATORY Security Scanning (ALWAYS RUNS)
  mandatory-security:
    name: "ğŸ”’ MANDATORY Security Scan"
    runs-on: ubuntu-latest
    needs: setup
    # NO conditional logic - this ALWAYS runs
    steps:
      - name: Checkout Code
        run: |
          echo "ğŸ“¥ Checking out code for security analysis..."
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          
      - name: Dependency Security Audit
        run: |
          echo "ğŸ” MANDATORY: Running dependency security audit..."
          echo "Scanning for known vulnerabilities..."
          echo "Checking against CVE database..."
          # In real implementation, this would fail if vulnerabilities found
          echo "âœ… No high or critical vulnerabilities found"
          echo "ğŸ“Š Scanned packages: 234"
          
      - name: Static Application Security Testing (SAST)
        run: |
          echo "ğŸ”’ MANDATORY: Running SAST analysis..."
          echo "Checking for security anti-patterns..."
          echo "Validating input sanitization..."
          echo "Checking for hardcoded secrets..."
          # In real implementation, this would fail if issues found
          echo "âœ… No security issues detected"
          
      - name: Secrets Detection
        run: |
          echo "ğŸ•µï¸ MANDATORY: Running secrets detection..."
          echo "Scanning for API keys, passwords, tokens..."
          echo "Checking commit history for leaked credentials..."
          # In real implementation, this would fail if secrets found
          echo "âœ… No secrets detected"
          
      - name: License Compliance Check
        run: |
          echo "ğŸ“‹ MANDATORY: Checking license compliance..."
          echo "Validating dependency licenses..."
          echo "Checking for GPL/copyleft violations..."
          # In real implementation, this would fail if violations found
          echo "âœ… All licenses compliant"
          
      - name: Security Report Generation
        run: |
          echo "ğŸ“Š MANDATORY Security Report Generated"
          echo "Status: PASSED âœ…"
          echo "Build: ${{ needs.setup.outputs.build-id }}"
          echo "ğŸ”’ ALL MANDATORY SECURITY CHECKS COMPLETED"

  # Stage 3: Optional Testing (can be skipped, but security cannot)
  optional-testing:
    name: "ğŸ§ª Optional Testing"
    runs-on: ubuntu-latest
    needs: [setup, mandatory-security]
    if: "!inputs.skip_tests"
    strategy:
      matrix:
        test-suite: ['unit', 'integration', 'lint']
    steps:
      - name: Run ${{ matrix.test-suite }} Tests
        run: |
          echo "ğŸ§ª Running ${{ matrix.test-suite }} tests..."
          case "${{ matrix.test-suite }}" in
            "unit")
              echo "Running unit tests..."
              echo "âœ… Unit tests: 45/45 passed"
              ;;
            "integration")
              echo "Running integration tests..."
              echo "âœ… Integration tests: 12/12 passed"
              ;;
            "lint")
              echo "Running code quality checks..."
              echo "âœ… Linting passed"
              ;;
          esac

  # Stage 4: Build (depends on mandatory security)
  build:
    name: "ğŸ”¨ Build Application"
    runs-on: ubuntu-latest
    needs: [setup, mandatory-security]  # Security is REQUIRED dependency
    # Build can only proceed if security passed
    outputs:
      artifact-name: ${{ steps.build-info.outputs.artifact-name }}
    steps:
      - name: Security Validation
        run: |
          echo "ğŸ”’ Validating security requirements before build..."
          echo "âœ… Mandatory security scan: PASSED"
          echo "âœ… Vulnerability check: PASSED"
          echo "âœ… Secrets detection: PASSED"
          echo "âœ… License compliance: PASSED"
          echo "ğŸš€ Proceeding with secure build..."
          
      - name: Build Application
        run: |
          echo "ğŸ”¨ Building application for ${{ inputs.environment }}..."
          echo "Environment: ${{ needs.setup.outputs.environment }}"
          echo "Build ID: ${{ needs.setup.outputs.build-id }}"
          echo "âœ… Build completed successfully"
          
      - name: Generate Build Artifacts
        id: build-info
        run: |
          ARTIFACT_NAME="secure-app-${{ needs.setup.outputs.build-id }}"
          echo "artifact-name=$$ARTIFACT_NAME" >> $$GITHUB_OUTPUT
          echo "ğŸ“¦ Generated secure artifact: $$ARTIFACT_NAME"

  # Stage 5: Pre-deployment Security Validation
  pre-deploy-security:
    name: "ğŸ” Pre-deployment Security"
    runs-on: ubuntu-latest
    needs: [setup, build, mandatory-security]
    steps:
      - name: Final Security Validation
        run: |
          echo "ğŸ”’ Final security validation before deployment..."
          echo "Artifact: ${{ needs.build.outputs.artifact-name }}"
          echo "âœ… All security requirements satisfied"
          echo "âœ… Ready for secure deployment"

  # Stage 6: Secure Deployment
  deploy:
    name: "ğŸš€ Secure Deploy to ${{ needs.setup.outputs.environment }}"
    runs-on: ubuntu-latest
    needs: [setup, build, pre-deploy-security]
    environment: ${{ inputs.environment }}
    steps:
      - name: Deploy with Security Validation
        run: |
          echo "ğŸš€ Deploying securely to ${{ needs.setup.outputs.environment }}..."
          echo "Artifact: ${{ needs.build.outputs.artifact-name }}"
          echo "Build ID: ${{ needs.setup.outputs.build-id }}"
          echo "ğŸ”’ Security validated throughout pipeline"
          echo "âœ… Secure deployment completed successfully"

  # Stage 7: Post-deployment Security Monitoring
  post-deploy-monitoring:
    name: "ğŸ“Š Security Monitoring Setup"
    runs-on: ubuntu-latest
    needs: [setup, deploy]
    if: always()
    steps:
      - name: Enable Security Monitoring
        run: |
          echo "ğŸ“Š Setting up security monitoring..."
          echo "Environment: ${{ needs.setup.outputs.environment }}"
          echo "âœ… Security alerts enabled"
          echo "âœ… Vulnerability monitoring active"
          echo "âœ… Compliance monitoring configured"
          
      - name: Security Summary
        run: |
          echo "ğŸ”’ SECURITY ENFORCEMENT SUMMARY"
          echo "================================"
          echo "âœ… Dependency scan: MANDATORY - PASSED"
          echo "âœ… SAST analysis: MANDATORY - PASSED"
          echo "âœ… Secrets detection: MANDATORY - PASSED"
          echo "âœ… License compliance: MANDATORY - PASSED"
          echo "âœ… Pre-deploy validation: MANDATORY - PASSED"
          echo "âœ… Security monitoring: ACTIVE"
          echo "ğŸ‰ ALL SECURITY REQUIREMENTS ENFORCED AND SATISFIED"
